# MES + MFA 委外加工管理系統 Demo

## 專案目的

展示如何運用 **MES（製造執行系統）** 與 **MFA（物質流分析）** 技術，解決委外加工的複雜追溯問題。

## 業務場景

- 母公司委託 **2 家加工廠**（P公司、CG公司）
- **4 道加工工序**，流程交錯
- 半成品會**混合**
- 每批生產會**混用之前剩餘原料**
- 中間站點有**半成品殘留**
- 最終產品為**粉末**（經脫水處理）

## 生產流程

```
站點A (收料)        ← M公司 + P公司 供料
    ↓
站點B (前處理)      ← CG公司加工
    ↓
┌───────────────────────────────────────────┐
│   站點C (平行加水) - 加水3倍                  │
│  C_CG: CG公司加水站 (各自有餘料)           │
│  C_P:  P公司加水站  (各自有餘料)           │
└───────────────────────────────────────────┘
    ↓
┌───────────────────────────────────────────┐
│   站點D (平行脫水)                            │
│  D_CG: CG公司脫水站 (各自有餘料)           │
│  D_P:  P公司脫水站  (各自有餘料)           │
└───────────────────────────────────────────┘
    ↓
站點E (混合/成品)  ← 合流 + 餘料混入 → 脫水成粉末
```

## 專案結構

```
MESnMFA/
├── README.md                    # 本文件
├── prompts/
│   └── flowchart_prompt.md      # Google AI Studio 用 Prompt
├── data/
│   └── simulated_production.csv # 模擬生產數據
├── models/
│   └── mass_balance.py          # 物質流分析數學模型
└── demo/
    └── demo_script.md           # Demo 演示腳本
```

## 核心數學模型

### 現實限制

- ❗ **無法取得乾重**：所有物料都含水分
- ❗ **餘料是估算的**：無法精確秤重
- ❗ **廢料是估算的**：反應器殘留量
- ✅ **可靠數據**：投入重、產出重、加水量

### 轉換率模型（基於可靠數據）

```
轉換率 = 產出濕重 / (投入濕重 + 加水量)

隱藏損耗 = 投入 + 加水 - 產出 = 廢料(估) + 餘料變化(估) + 真實損耗
```

### 異常偵測邏輯

```
單批轉換率 vs 歷史平均轉換率
偏離 > 2倍標準差 → 異常警示
```

### 批次譜系追蹤（FIFO 加權平均）

```
Batch_E 成分 = 
  α × Batch_D_CG 
+ β × Batch_D_P 
+ γ × Remnant_E_Previous

其中 α + β + γ = 1
```

## Demo 展示重點

1. **流程可視化** - AI 生成 Mermaid 流程圖
2. **異常偵測** - 識別含水率/產出異常
3. **批次追溯** - 正向/反向譜系分析
4. **餘料管理** - 量化餘料對成品的影響

## 使用方式

1. 將 `prompts/flowchart_prompt.md` 內容貼到 Google AI Studio
2. 使用 `data/simulated_production.csv` 進行數據分析
3. 執行 `models/mass_balance.py` 進行物質流計算
4. 參考 `demo/demo_script.md` 進行客戶演示
