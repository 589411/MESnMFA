<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES + MFA ç‰©è³ªæµåˆ†æ Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-normal {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
            border: 1px solid rgba(46, 213, 115, 0.3);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .status-critical {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        .container {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 1.5rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title .icon {
            font-size: 1.3rem;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* æµç¨‹åœ–æ¨£å¼ */
        .flow-diagram {
            min-height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mermaid {
            width: 100%;
        }

        /* ç«™é»å¡ç‰‡ */
        .stations-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
        }

        .station-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.3s;
        }

        .station-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #00d4ff;
        }

        .station-card.active {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
        }

        .station-card.anomaly {
            border-color: #ff4757;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
        }

        .station-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .station-rate {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .station-label {
            font-size: 0.75rem;
            color: #888;
        }

        /* åœ–è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            height: 280px;
        }

        /* ç•°å¸¸åˆ—è¡¨ */
        .anomaly-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .anomaly-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(255, 71, 87, 0.1);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 3px solid #ff4757;
        }

        .anomaly-item .info {
            flex: 1;
        }

        .anomaly-item .batch {
            font-weight: 600;
            color: #ff4757;
        }

        .anomaly-item .detail {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 0.25rem;
        }

        .anomaly-item .z-score {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ff4757;
        }

        /* è­œç³»è¿½è¹¤ */
        .genealogy-section {
            display: flex;
            gap: 1rem;
        }

        .genealogy-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 1rem;
        }

        .genealogy-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #00d4ff;
        }

        .genealogy-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.85rem;
        }

        .genealogy-item:last-child {
            border-bottom: none;
        }

        /* æ‰¹æ¬¡é¸æ“‡å™¨ */
        .batch-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .batch-btn {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .batch-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .batch-btn.active {
            background: #00d4ff;
            color: #1a1a2e;
            border-color: #00d4ff;
        }

        .batch-btn.anomaly {
            border-color: #ff4757;
            color: #ff4757;
        }

        .batch-btn.anomaly.active {
            background: #ff4757;
            color: white;
        }

        /* Sankey é¢¨æ ¼çš„æµç¨‹å‹•ç•« */
        .flow-animation {
            position: relative;
            height: 120px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .flow-node {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }

        .flow-node.source-m {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .flow-node.source-p {
            background: linear-gradient(135deg, #27ae60, #1e8449);
        }

        .flow-node.cg {
            background: linear-gradient(135deg, #e67e22, #d35400);
        }

        .flow-node.mixed {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .flow-node.product {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .flow-value {
            font-size: 1rem;
            font-weight: 700;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .stations-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stations-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .genealogy-section {
                flex-direction: column;
            }
        }

        /* æ•¸æ“šè¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            font-weight: 600;
            color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* å‹•æ…‹æµé‡æŒ‡ç¤ºå™¨ */
        .flow-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .flow-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .flow-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .flow-bar-fill.input {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
        }

        .flow-bar-fill.output {
            background: linear-gradient(90deg, #2ed573, #1e90ff);
        }

        .flow-bar-fill.remnant {
            background: linear-gradient(90deg, #ffa502, #ff6348);
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ­ MES + MFA ç‰©è³ªæµåˆ†æç³»çµ±</h1>
        <div class="status">
            <span class="status-badge status-normal" id="normalCount">æ­£å¸¸: 33</span>
            <span class="status-badge status-critical" id="anomalyCount">ç•°å¸¸: 2</span>
        </div>
    </header>

    <div class="container">
        <!-- æµç¨‹åœ– -->
        <div class="card full-width">
            <div class="card-title">
                <span class="icon">ğŸ”„</span>
                ç”Ÿç”¢æµç¨‹åœ–
            </div>
            <div class="flow-diagram">
                <div class="mermaid" id="flowchart">
                </div>
            </div>
        </div>

        <!-- ç«™é»æ¦‚è¦½ -->
        <div class="card full-width">
            <div class="card-title">
                <span class="icon">ğŸ“Š</span>
                å„ç«™é»è½‰æ›ç‡ï¼ˆé»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼‰
            </div>
            <div class="stations-grid" id="stationsGrid">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- è½‰æ›ç‡è¶¨å‹¢åœ– -->
        <div class="card">
            <div class="card-title">
                <span class="icon">ğŸ“ˆ</span>
                è½‰æ›ç‡è¶¨å‹¢
            </div>
            <div class="chart-container">
                <canvas id="conversionChart"></canvas>
            </div>
        </div>

        <!-- ç•°å¸¸åµæ¸¬ -->
        <div class="card">
            <div class="card-title">
                <span class="icon">âš ï¸</span>
                ç•°å¸¸åµæ¸¬
            </div>
            <div class="anomaly-list" id="anomalyList">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç‰©æ–™æµé‡åœ– -->
        <div class="card">
            <div class="card-title">
                <span class="icon">ğŸŒŠ</span>
                ç‰©æ–™æµé‡åˆ†æ
            </div>
            <div class="batch-selector" id="batchSelector">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div id="flowAnalysis">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ‰¹æ¬¡è­œç³» -->
        <div class="card">
            <div class="card-title">
                <span class="icon">ğŸ§¬</span>
                æ‰¹æ¬¡è­œç³»è¿½è¹¤
            </div>
            <div class="batch-selector" id="genealogyBatchSelector">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div class="genealogy-section" id="genealogySection">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é¤˜æ–™å½±éŸ¿åˆ†æ -->
        <div class="card full-width">
            <div class="card-title">
                <span class="icon">ğŸ“¦</span>
                é¤˜æ–™ç©©æ…‹ä¼°ç®—èˆ‡å½±éŸ¿åˆ†æ
            </div>
            <div class="chart-container" style="height: 200px;">
                <canvas id="remnantChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // æ¨¡æ“¬æ•¸æ“š
        // ============================================================
        // æ›´æ–°å¾Œçš„æµç¨‹ï¼šA â†’ B â†’ åˆ†æµ â†’ C_CG/C_P(å¹³è¡ŒåŠ æ°´,åŠ æ°´3å€) â†’ D_CG/D_P(å¹³è¡Œè„«æ°´) â†’ E(åˆæµ)
        const productionData = [
            // B001
            {date: '2024-01-01', batch: 'B001', station: 'A', owner: 'Mixed', input: 1000, remnantIn: 0, water: 0, output: 980, remnantOut: 15, waste: 5, rate: 0.980, status: 'Normal'},
            {date: '2024-01-01', batch: 'B001', station: 'B', owner: 'CG_Corp', input: 980, remnantIn: 0, water: 0, output: 950, remnantOut: 20, waste: 10, rate: 0.969, status: 'Normal'},
            {date: '2024-01-01', batch: 'B001', station: 'C_CG', owner: 'CG_Corp', input: 475, remnantIn: 0, water: 1425, output: 1870, remnantOut: 30, waste: 10, rate: 0.984, status: 'Normal'},
            {date: '2024-01-01', batch: 'B001', station: 'C_P', owner: 'P_Corp', input: 475, remnantIn: 0, water: 1425, output: 1865, remnantOut: 28, waste: 12, rate: 0.981, status: 'Normal'},
            {date: '2024-01-01', batch: 'B001', station: 'D_CG', owner: 'CG_Corp', input: 1870, remnantIn: 0, water: 0, output: 480, remnantOut: 25, waste: 15, rate: 0.257, status: 'Normal'},
            {date: '2024-01-01', batch: 'B001', station: 'D_P', owner: 'P_Corp', input: 1865, remnantIn: 0, water: 0, output: 475, remnantOut: 22, waste: 18, rate: 0.255, status: 'Normal'},
            {date: '2024-01-01', batch: 'B001', station: 'E', owner: 'Mixed', input: 955, remnantIn: 0, water: 0, output: 450, remnantOut: 12, waste: 8, rate: 0.471, status: 'Normal'},
            
            // B002
            {date: '2024-01-02', batch: 'B002', station: 'A', owner: 'Mixed', input: 1000, remnantIn: 15, water: 0, output: 990, remnantOut: 18, waste: 7, rate: 0.975, status: 'Normal'},
            {date: '2024-01-02', batch: 'B002', station: 'B', owner: 'CG_Corp', input: 990, remnantIn: 20, water: 0, output: 975, remnantOut: 22, waste: 13, rate: 0.966, status: 'Normal'},
            {date: '2024-01-02', batch: 'B002', station: 'C_CG', owner: 'CG_Corp', input: 488, remnantIn: 30, water: 1464, output: 1948, remnantOut: 35, waste: 12, rate: 0.983, status: 'Normal'},
            {date: '2024-01-02', batch: 'B002', station: 'C_P', owner: 'P_Corp', input: 487, remnantIn: 28, water: 1461, output: 1940, remnantOut: 32, waste: 14, rate: 0.982, status: 'Normal'},
            {date: '2024-01-02', batch: 'B002', station: 'D_CG', owner: 'CG_Corp', input: 1948, remnantIn: 25, water: 0, output: 510, remnantOut: 28, waste: 18, rate: 0.258, status: 'Normal'},
            {date: '2024-01-02', batch: 'B002', station: 'D_P', owner: 'P_Corp', input: 1940, remnantIn: 22, water: 0, output: 502, remnantOut: 25, waste: 20, rate: 0.256, status: 'Normal'},
            {date: '2024-01-02', batch: 'B002', station: 'E', owner: 'Mixed', input: 1012, remnantIn: 12, water: 0, output: 485, remnantOut: 14, waste: 10, rate: 0.474, status: 'Normal'},
            
            // B003 - ç•°å¸¸æ‰¹æ¬¡
            {date: '2024-01-03', batch: 'B003', station: 'A', owner: 'Mixed', input: 1000, remnantIn: 18, water: 0, output: 985, remnantOut: 20, waste: 13, rate: 0.968, status: 'Normal'},
            {date: '2024-01-03', batch: 'B003', station: 'B', owner: 'CG_Corp', input: 985, remnantIn: 22, water: 0, output: 970, remnantOut: 25, waste: 12, rate: 0.963, status: 'Normal'},
            {date: '2024-01-03', batch: 'B003', station: 'C_CG', owner: 'CG_Corp', input: 485, remnantIn: 35, water: 1455, output: 1942, remnantOut: 38, waste: 10, rate: 0.983, status: 'Normal'},
            {date: '2024-01-03', batch: 'B003', station: 'C_P', owner: 'P_Corp', input: 485, remnantIn: 32, water: 1455, output: 1938, remnantOut: 35, waste: 12, rate: 0.982, status: 'Normal'},
            {date: '2024-01-03', batch: 'B003', station: 'D_CG', owner: 'CG_Corp', input: 1942, remnantIn: 28, water: 0, output: 620, remnantOut: 30, waste: 8, rate: 0.319, status: 'Anomaly_High'},
            {date: '2024-01-03', batch: 'B003', station: 'D_P', owner: 'P_Corp', input: 1938, remnantIn: 25, water: 0, output: 498, remnantOut: 27, waste: 18, rate: 0.257, status: 'Normal'},
            {date: '2024-01-03', batch: 'B003', station: 'E', owner: 'Mixed', input: 1118, remnantIn: 14, water: 0, output: 580, remnantOut: 16, waste: 9, rate: 0.512, status: 'Anomaly_High'},
            
            // B004
            {date: '2024-01-04', batch: 'B004', station: 'A', owner: 'Mixed', input: 1000, remnantIn: 20, water: 0, output: 988, remnantOut: 17, waste: 15, rate: 0.969, status: 'Normal'},
            {date: '2024-01-04', batch: 'B004', station: 'B', owner: 'CG_Corp', input: 988, remnantIn: 25, water: 0, output: 978, remnantOut: 23, waste: 12, rate: 0.965, status: 'Normal'},
            {date: '2024-01-04', batch: 'B004', station: 'C_CG', owner: 'CG_Corp', input: 489, remnantIn: 38, water: 1467, output: 1960, remnantOut: 36, waste: 13, rate: 0.983, status: 'Normal'},
            {date: '2024-01-04', batch: 'B004', station: 'C_P', owner: 'P_Corp', input: 489, remnantIn: 35, water: 1467, output: 1955, remnantOut: 33, waste: 15, rate: 0.981, status: 'Normal'},
            {date: '2024-01-04', batch: 'B004', station: 'D_CG', owner: 'CG_Corp', input: 1960, remnantIn: 30, water: 0, output: 505, remnantOut: 26, waste: 14, rate: 0.254, status: 'Normal'},
            {date: '2024-01-04', batch: 'B004', station: 'D_P', owner: 'P_Corp', input: 1955, remnantIn: 27, water: 0, output: 508, remnantOut: 24, waste: 16, rate: 0.257, status: 'Normal'},
            {date: '2024-01-04', batch: 'B004', station: 'E', owner: 'Mixed', input: 1013, remnantIn: 16, water: 0, output: 490, remnantOut: 13, waste: 9, rate: 0.477, status: 'Normal'},
            
            // B005
            {date: '2024-01-05', batch: 'B005', station: 'A', owner: 'Mixed', input: 1000, remnantIn: 17, water: 0, output: 985, remnantOut: 19, waste: 13, rate: 0.969, status: 'Normal'},
            {date: '2024-01-05', batch: 'B005', station: 'B', owner: 'CG_Corp', input: 985, remnantIn: 23, water: 0, output: 972, remnantOut: 21, waste: 15, rate: 0.964, status: 'Normal'},
            {date: '2024-01-05', batch: 'B005', station: 'C_CG', owner: 'CG_Corp', input: 486, remnantIn: 36, water: 1458, output: 1945, remnantOut: 34, waste: 14, rate: 0.982, status: 'Normal'},
            {date: '2024-01-05', batch: 'B005', station: 'C_P', owner: 'P_Corp', input: 486, remnantIn: 33, water: 1458, output: 1940, remnantOut: 31, waste: 16, rate: 0.980, status: 'Normal'},
            {date: '2024-01-05', batch: 'B005', station: 'D_CG', owner: 'CG_Corp', input: 1945, remnantIn: 26, water: 0, output: 498, remnantOut: 24, waste: 17, rate: 0.253, status: 'Normal'},
            {date: '2024-01-05', batch: 'B005', station: 'D_P', owner: 'P_Corp', input: 1940, remnantIn: 24, water: 0, output: 495, remnantOut: 22, waste: 19, rate: 0.252, status: 'Normal'},
            {date: '2024-01-05', batch: 'B005', station: 'E', owner: 'Mixed', input: 993, remnantIn: 13, water: 0, output: 475, remnantOut: 11, waste: 8, rate: 0.472, status: 'Normal'}
        ];

        const stationConfig = {
            'A': {name: 'æ”¶æ–™ç«™', expectedRate: 0.97, color: '#9b59b6', owner: 'Mixed'},
            'B': {name: 'å‰è™•ç†ç«™', expectedRate: 0.965, color: '#e67e22', owner: 'CG'},
            'C_CG': {name: 'CGåŠ æ°´ç«™', expectedRate: 0.98, color: '#e67e22', owner: 'CG'},
            'C_P': {name: 'PåŠ æ°´ç«™', expectedRate: 0.98, color: '#27ae60', owner: 'P'},
            'D_CG': {name: 'CGè„«æ°´ç«™', expectedRate: 0.26, color: '#e67e22', owner: 'CG'},
            'D_P': {name: 'Pè„«æ°´ç«™', expectedRate: 0.26, color: '#27ae60', owner: 'P'},
            'E': {name: 'æ··åˆæˆå“ç«™', expectedRate: 0.47, color: '#9b59b6', owner: 'Mixed'}
        };

        const batches = ['B001', 'B002', 'B003', 'B004', 'B005'];
        const stations = ['A', 'B', 'C_CG', 'C_P', 'D_CG', 'D_P', 'E'];

        let selectedBatch = 'B003';
        let selectedStation = 'D_CG';

        // ============================================================
        // åˆå§‹åŒ–
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            initMermaid();
            renderStationsGrid();
            renderConversionChart();
            renderAnomalyList();
            renderBatchSelector();
            renderFlowAnalysis();
            renderGenealogySection();
            renderRemnantChart();
        });

        // ============================================================
        // Mermaid æµç¨‹åœ–
        // ============================================================
        function initMermaid() {
            mermaid.initialize({
                startOnLoad: false,
                theme: 'dark',
                themeVariables: {
                    primaryColor: '#9b59b6',
                    primaryTextColor: '#fff',
                    primaryBorderColor: '#7b2cbf',
                    lineColor: '#00d4ff',
                    secondaryColor: '#e67e22',
                    tertiaryColor: '#27ae60'
                }
            });

            const flowchartDef = `
            graph LR
                subgraph åŸæ–™ä¾†æº["ğŸ­ åŸæ–™ä¾†æº"]
                    M[("æ¯å…¬å¸ M")]
                    P_in[("På…¬å¸ä¾›æ–™")]
                end
                
                subgraph ç«™é»A["ç«™é» A - æ”¶æ–™"]
                    A[æ··åˆåŸæ–™<br/>è½‰æ›ç‡ 97%]
                end
                
                subgraph ç«™é»B["ç«™é» B - å‰è™•ç† (CGå…¬å¸)"]
                    B[å‰è™•ç†<br/>è½‰æ›ç‡ 96.5%]
                end
                
                subgraph å¹³è¡ŒåŠ æ°´["ç«™é» C - å¹³è¡ŒåŠ æ°´ (åŠ æ°´3å€)"]
                    C_CG["CGå…¬å¸åŠ æ°´<br/>è½‰æ›ç‡ 98%"]
                    C_P["På…¬å¸åŠ æ°´<br/>è½‰æ›ç‡ 98%"]
                end
                
                subgraph å¹³è¡Œè„«æ°´["ç«™é» D - å¹³è¡Œè„«æ°´"]
                    D_CG["CGå…¬å¸è„«æ°´<br/>è½‰æ›ç‡ 26%"]
                    D_P["På…¬å¸è„«æ°´<br/>è½‰æ›ç‡ 26%"]
                end
                
                subgraph ç«™é»E["ç«™é» E - æ··åˆæˆå“"]
                    E[æ··åˆè„«æ°´<br/>è½‰æ›ç‡ 47%]
                end
                
                M --> A
                P_in --> A
                A --> B
                B -->|åˆ†æµè‡³CG| C_CG
                B -->|åˆ†æµè‡³P| C_P
                C_CG -->|"+3å€æ°´"| D_CG
                C_P -->|"+3å€æ°´"| D_P
                D_CG --> E
                D_P --> E
                E --> æˆå“["ğŸ“¦ æˆå“ç²‰æœ«"]
                
                A -.->|é¤˜æ–™| A
                B -.->|é¤˜æ–™| B
                C_CG -.->|é¤˜æ–™| C_CG
                C_P -.->|é¤˜æ–™| C_P
                D_CG -.->|é¤˜æ–™| D_CG
                D_P -.->|é¤˜æ–™| D_P
                E -.->|é¤˜æ–™| E
            `;

            const element = document.getElementById('flowchart');
            mermaid.render('flowchartSvg', flowchartDef).then(result => {
                element.innerHTML = result.svg;
            });
        }

        // ============================================================
        // ç«™é»æ¦‚è¦½
        // ============================================================
        function renderStationsGrid() {
            const grid = document.getElementById('stationsGrid');
            grid.innerHTML = '';

            stations.forEach(station => {
                const config = stationConfig[station];
                const stationData = productionData.filter(d => d.station === station);
                const avgRate = stationData.reduce((sum, d) => sum + d.rate, 0) / stationData.length;
                const hasAnomaly = stationData.some(d => d.status.includes('Anomaly'));

                const card = document.createElement('div');
                card.className = `station-card ${station === selectedStation ? 'active' : ''} ${hasAnomaly ? 'anomaly' : ''}`;
                card.onclick = () => selectStation(station);

                const rateColor = Math.abs(avgRate - config.expectedRate) > 0.05 ? '#ff4757' : '#2ed573';

                card.innerHTML = `
                    <div class="station-name">${config.name}</div>
                    <div class="station-rate" style="color: ${rateColor}">${(avgRate * 100).toFixed(1)}%</div>
                    <div class="station-label">å¹³å‡è½‰æ›ç‡</div>
                    <div class="station-label" style="color: #888">é æœŸ ${(config.expectedRate * 100).toFixed(1)}%</div>
                `;

                grid.appendChild(card);
            });
        }

        function selectStation(station) {
            selectedStation = station;
            renderStationsGrid();
            renderConversionChart();
        }

        // ============================================================
        // è½‰æ›ç‡è¶¨å‹¢åœ–
        // ============================================================
        let conversionChart = null;

        function renderConversionChart() {
            const ctx = document.getElementById('conversionChart').getContext('2d');
            
            if (conversionChart) {
                conversionChart.destroy();
            }

            const stationData = productionData.filter(d => d.station === selectedStation);
            const config = stationConfig[selectedStation];

            conversionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: stationData.map(d => d.batch),
                    datasets: [
                        {
                            label: 'å¯¦éš›è½‰æ›ç‡',
                            data: stationData.map(d => d.rate),
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: stationData.map(d => 
                                d.status.includes('Anomaly') ? '#ff4757' : '#00d4ff'
                            ),
                            pointRadius: stationData.map(d => 
                                d.status.includes('Anomaly') ? 8 : 4
                            ),
                            pointBorderWidth: 2
                        },
                        {
                            label: 'é æœŸè½‰æ›ç‡',
                            data: stationData.map(() => config.expectedRate),
                            borderColor: '#2ed573',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        },
                        title: {
                            display: true,
                            text: `${config.name} (${selectedStation}) è½‰æ›ç‡è¶¨å‹¢`,
                            color: '#e0e0e0'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#888',
                                callback: value => (value * 100).toFixed(0) + '%'
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // ============================================================
        // ç•°å¸¸åˆ—è¡¨
        // ============================================================
        function renderAnomalyList() {
            const list = document.getElementById('anomalyList');
            const anomalies = productionData.filter(d => d.status.includes('Anomaly'));

            if (anomalies.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #2ed573; padding: 2rem;">âœ… ç„¡ç•°å¸¸</div>';
                return;
            }

            list.innerHTML = anomalies.map(a => {
                const config = stationConfig[a.station];
                const zScore = Math.abs(a.rate - config.expectedRate) / 0.01;
                
                return `
                    <div class="anomaly-item">
                        <div class="info">
                            <div class="batch">${a.batch} @ ${config.name}</div>
                            <div class="detail">
                                è½‰æ›ç‡ ${(a.rate * 100).toFixed(1)}% (é æœŸ ${(config.expectedRate * 100).toFixed(1)}%)
                            </div>
                        </div>
                        <div class="z-score">Z=${zScore.toFixed(1)}</div>
                    </div>
                `;
            }).join('');
        }

        // ============================================================
        // æ‰¹æ¬¡é¸æ“‡å™¨
        // ============================================================
        function renderBatchSelector() {
            const selector = document.getElementById('batchSelector');
            const genealogySelector = document.getElementById('genealogyBatchSelector');

            const html = batches.map(batch => {
                const hasAnomaly = productionData.some(d => d.batch === batch && d.status.includes('Anomaly'));
                return `
                    <button class="batch-btn ${batch === selectedBatch ? 'active' : ''} ${hasAnomaly ? 'anomaly' : ''}"
                            onclick="selectBatch('${batch}')">
                        ${batch} ${hasAnomaly ? 'âš ï¸' : ''}
                    </button>
                `;
            }).join('');

            selector.innerHTML = html;
            genealogySelector.innerHTML = html.replace(/selectBatch/g, 'selectGenealogyBatch');
        }

        function selectBatch(batch) {
            selectedBatch = batch;
            renderBatchSelector();
            renderFlowAnalysis();
        }

        function selectGenealogyBatch(batch) {
            selectedBatch = batch;
            renderBatchSelector();
            renderGenealogySection();
        }

        // ============================================================
        // ç‰©æ–™æµé‡åˆ†æ
        // ============================================================
        function renderFlowAnalysis() {
            const container = document.getElementById('flowAnalysis');
            const batchData = productionData.filter(d => d.batch === selectedBatch);

            container.innerHTML = batchData.map(d => {
                const config = stationConfig[d.station];
                const totalInput = d.input + d.remnantIn + d.water;
                const inputPercent = (d.input / totalInput * 100).toFixed(0);
                const remnantPercent = (d.remnantIn / totalInput * 100).toFixed(0);
                const waterPercent = (d.water / totalInput * 100).toFixed(0);
                const outputPercent = (d.output / totalInput * 100).toFixed(0);

                return `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: ${d.status.includes('Anomaly') ? '#ff4757' : '#00d4ff'}">
                            ${config.name} ${d.status.includes('Anomaly') ? 'âš ï¸' : ''}
                        </div>
                        <div class="flow-indicator">
                            <span style="width: 60px; font-size: 0.75rem;">æŠ•å…¥</span>
                            <div class="flow-bar">
                                <div class="flow-bar-fill input" style="width: ${inputPercent}%"></div>
                            </div>
                            <span style="width: 50px; text-align: right; font-size: 0.85rem;">${d.input}kg</span>
                        </div>
                        ${d.remnantIn > 0 ? `
                        <div class="flow-indicator">
                            <span style="width: 60px; font-size: 0.75rem;">é¤˜æ–™</span>
                            <div class="flow-bar">
                                <div class="flow-bar-fill remnant" style="width: ${remnantPercent}%"></div>
                            </div>
                            <span style="width: 50px; text-align: right; font-size: 0.85rem;">${d.remnantIn}kg</span>
                        </div>
                        ` : ''}
                        ${d.water > 0 ? `
                        <div class="flow-indicator">
                            <span style="width: 60px; font-size: 0.75rem;">åŠ æ°´</span>
                            <div class="flow-bar">
                                <div class="flow-bar-fill" style="width: ${waterPercent}%; background: #3498db;"></div>
                            </div>
                            <span style="width: 50px; text-align: right; font-size: 0.85rem;">${d.water}kg</span>
                        </div>
                        ` : ''}
                        <div class="flow-indicator">
                            <span style="width: 60px; font-size: 0.75rem;">ç”¢å‡º</span>
                            <div class="flow-bar">
                                <div class="flow-bar-fill output" style="width: ${outputPercent}%"></div>
                            </div>
                            <span style="width: 50px; text-align: right; font-size: 0.85rem;">${d.output}kg</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================================
        // æ‰¹æ¬¡è­œç³»
        // ============================================================
        function renderGenealogySection() {
            const container = document.getElementById('genealogySection');
            const batchData = productionData.filter(d => d.batch === selectedBatch);
            const batchIndex = batches.indexOf(selectedBatch);

            // åå‘è¿½æº¯
            const backwardHtml = batchData.map(d => {
                const totalInput = d.input + d.remnantIn + d.water;
                const newRatio = ((d.input + d.water) / totalInput * 100).toFixed(1);
                const remnantRatio = (d.remnantIn / totalInput * 100).toFixed(1);
                const prevBatch = batchIndex > 0 ? batches[batchIndex - 1] : '-';

                return `
                    <div class="genealogy-item">
                        <span>${stationConfig[d.station].name}</span>
                        <span>æ–°æ–™ ${newRatio}% + é¤˜æ–™ ${remnantRatio}%</span>
                    </div>
                `;
            }).join('');

            // æ­£å‘è¿½æº¯
            let forwardHtml = '';
            if (batchIndex < batches.length - 1) {
                const nextBatches = batches.slice(batchIndex + 1);
                forwardHtml = nextBatches.map(nextBatch => {
                    const nextData = productionData.filter(d => d.batch === nextBatch);
                    const avgRemnantRatio = nextData.reduce((sum, d) => {
                        const total = d.input + d.remnantIn + d.water;
                        return sum + (d.remnantIn / total);
                    }, 0) / nextData.length * 100;

                    return `
                        <div class="genealogy-item">
                            <span>${nextBatch}</span>
                            <span>å« ${avgRemnantRatio.toFixed(1)}% é¤˜æ–™</span>
                        </div>
                    `;
                }).join('');
            } else {
                forwardHtml = '<div style="color: #888; font-size: 0.85rem;">é€™æ˜¯æœ€å¾Œä¸€æ‰¹</div>';
            }

            container.innerHTML = `
                <div class="genealogy-panel">
                    <div class="genealogy-title">â¬…ï¸ åå‘è¿½æº¯ï¼š${selectedBatch} çš„åŸæ–™çµ„æˆ</div>
                    ${backwardHtml}
                </div>
                <div class="genealogy-panel">
                    <div class="genealogy-title">â¡ï¸ æ­£å‘è¿½æº¯ï¼š${selectedBatch} å½±éŸ¿çš„å¾ŒçºŒæ‰¹æ¬¡</div>
                    ${forwardHtml}
                </div>
            `;
        }

        // ============================================================
        // é¤˜æ–™åœ–è¡¨
        // ============================================================
        let remnantChart = null;

        function renderRemnantChart() {
            const ctx = document.getElementById('remnantChart').getContext('2d');

            const remnantData = stations.map(station => {
                const stationData = productionData.filter(d => d.station === station);
                const avgIn = stationData.reduce((sum, d) => sum + d.remnantIn, 0) / stationData.length;
                const avgOut = stationData.reduce((sum, d) => sum + d.remnantOut, 0) / stationData.length;
                return { station, avgIn, avgOut, steadyState: (avgIn + avgOut) / 2 };
            });

            remnantChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: remnantData.map(d => stationConfig[d.station].name),
                    datasets: [
                        {
                            label: 'å¹³å‡é¤˜æ–™æŠ•å…¥',
                            data: remnantData.map(d => d.avgIn),
                            backgroundColor: 'rgba(255, 165, 2, 0.6)',
                            borderColor: '#ffa502',
                            borderWidth: 1
                        },
                        {
                            label: 'å¹³å‡é¤˜æ–™çµå­˜',
                            data: remnantData.map(d => d.avgOut),
                            backgroundColor: 'rgba(255, 99, 72, 0.6)',
                            borderColor: '#ff6348',
                            borderWidth: 1
                        },
                        {
                            label: 'ç©©æ…‹ä¼°ç®—',
                            data: remnantData.map(d => d.steadyState),
                            backgroundColor: 'rgba(0, 212, 255, 0.6)',
                            borderColor: '#00d4ff',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#888',
                                callback: value => value + ' kg'
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
